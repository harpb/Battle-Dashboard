// Generated by CoffeeScript 1.6.3
(function() {
  var BattleApp, BattleController;

  BattleController = function($scope, Restangular, Auth) {
    var battleApi, currentDate, getBattles, getPlayers, playerApi;
    $scope.authentication_credentials = {
      username: 'harp',
      password: 'great',
      isAuthenticated: false
    };
    $scope.login = function() {
      Auth.setCredentials($scope.authentication_credentials.username, $scope.authentication_credentials.password);
      $scope.authentication_credentials.isAuthenticated = true;
      getBattles();
      return getPlayers();
    };
    playerApi = Restangular.all("player/");
    battleApi = Restangular.all("battle/");
    getPlayers = function() {
      return $scope.playerList = playerApi.getList().then(function(response) {
        $scope.players = response['objects'];
        return console.info('players', $scope.players, $scope.playerList);
      });
    };
    $scope.playerPayload = {
      first_name: '',
      last_name: '',
      nickname: ''
    };
    $scope.savePlayer = function() {
      $scope.playerPayload.loading = true;
      return playerApi.post($scope.playerPayload).then(function(response) {
        $scope.playerPayload.loading = false;
        $scope.players.push(response);
        return $scope.resetNewPlayerForm();
      });
    };
    $scope.editPlayer = function(player) {
      return player.editing = true;
    };
    $scope.updatePlayer = function(player) {
      return player.editing = false;
    };
    $scope.newPlayerForm = function() {
      return $('.new.player.modal').modal('setting', {
        'transition': 'horizontal flip',
        onApprove: function() {
          return false;
        }
      }).modal('toggle');
    };
    $scope.resetNewPlayerForm = function() {
      $scope.playerPayload = {
        first_name: '',
        last_name: '',
        nickname: ''
      };
      return $scope.newPlayerForm();
    };
    getBattles = function() {
      return $scope.battleList = battleApi.getList().then(function(response) {
        return $scope.battles = response['objects'];
      });
    };
    $scope.newBattleForm = function() {
      return $('.new.battle.modal').modal('setting', {
        'transition': 'horizontal flip',
        onApprove: function() {
          return false;
        }
      }).modal('toggle');
    };
    $scope.resetNewBattleForm = function() {
      $scope.battlePayload = {
        attacker: null,
        defender: null,
        attacker_wins: false,
        start: currentDate.toISOString(),
        end: currentDate.toISOString()
      };
      return $scope.newBattleForm();
    };
    currentDate = new Date();
    $scope.battlePayload = {
      attacker: null,
      defender: null,
      attacker_wins: false,
      start: currentDate.toISOString(),
      end: currentDate.toISOString()
    };
    $scope.saveBattle = function() {
      $scope.battlePayload.loading = true;
      if ($scope.battlePayload.attacker_wins) {
        $scope.battlePayload.winner = $scope.battlePayload.attacker;
      } else {
        $scope.battlePayload.winner = $scope.battlePayload.defender;
      }
      return battleApi.post($scope.battlePayload).then(function(response) {
        $scope.battlePayload.loading = false;
        $scope.battles.push(response);
        return $scope.resetNewBattleForm();
      });
    };
    return $scope.login();
  };

  BattleApp = angular.module('BattleApp', ['restangular']);

  window.BattleApp = BattleApp;

  BattleApp.config(function(RestangularProvider) {
    return RestangularProvider.setBaseUrl('/api/v1/');
  });

  BattleApp.config(function($interpolateProvider) {
    $interpolateProvider.startSymbol('<<');
    return $interpolateProvider.endSymbol('>>');
  });

  BattleApp.controller('BattleController', BattleController);

}).call(this);
