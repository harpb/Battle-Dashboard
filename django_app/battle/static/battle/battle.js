// Generated by CoffeeScript 1.6.3
(function() {
  var BattleApp, BattleController;

  BattleController = function($scope, Restangular, Auth) {
    var battleApi, defaultValue, exampleDateTime, getBattles, getPlayers, laceholder, placeholder, playerApi;
    $scope.authentication_credentials = {
      username: 'harp',
      password: 'greatsolution',
      isAuthenticated: false
    };
    $scope.login = function() {
      console.info('$scope.login');
      Auth.setCredentials($scope.authentication_credentials.username, $scope.authentication_credentials.password);
      $scope.authentication_credentials.isAuthenticated = true;
      getBattles();
      return getPlayers();
    };
    playerApi = Restangular.all("player/");
    battleApi = Restangular.all("battle/");
    $scope.nicknameFilter = 'harp';
    $scope.filterPlayersForm = new AngularForm();
    $scope.filterPlayers = function($event, text) {
      if (text == null) {
        text = '';
      }
      $scope.nicknameFilter = text;
      console.info('filterPlayers', $event, $scope.nicknameFilter, text);
      getPlayers();
      return $event.preventDefault();
    };
    getPlayers = function() {
      var data;
      $scope.filterPlayersForm.submitting = true;
      data = {};
      if ($scope.nicknameFilter.length > 0) {
        data.nickname = $scope.nicknameFilter;
      }
      console.info('data', $scope.nicknameFilter, data);
      return $scope.playerList = playerApi.getList(data).then(function(response) {
        $scope.filterPlayersForm.submitting = false;
        return $scope.players = response['objects'];
      });
    };
    $scope.newPlayerForm = new AngularForm('.new.player.modal');
    $scope.newPlayerForm.addField('nickname', 'Nickname');
    $scope.newPlayerForm.addField('first_name', 'First Name');
    $scope.newPlayerForm.addField('last_name', 'Last Name');
    $scope.savePlayer = function($event) {
      $event.preventDefault();
      return $scope.newPlayerForm.submit(playerApi, $scope.players);
    };
    $scope.editPlayer = function(player) {
      return player.editing = true;
    };
    $scope.updatePlayer = function(player) {
      return player.editing = false;
    };
    exampleDateTime = '2013-12-10 6:10:00';
    $scope.filterBattlesForm = new AngularForm();
    $scope.filterBattlesForm.addField('from', 'Start', placeholder = exampleDateTime);
    $scope.filterBattlesForm.addField('to', 'End', laceholder = exampleDateTime);
    $scope.filterBattles = function($event, start, end) {
      if (start == null) {
        start = '';
      }
      if (end == null) {
        end = '';
      }
      console.info('filterPlayers', $event, start, end, $scope.filterBattlesForm.fields);
      getBattles();
      return $event.preventDefault();
    };
    getBattles = function() {
      var data;
      $scope.filterBattlesForm.submitting = true;
      data = {};
      if ($scope.filterBattlesForm.fields.from.value && $scope.filterBattlesForm.fields.from.value.length > 0) {
        data.start__gte = $scope.filterBattlesForm.fields.from.value;
      }
      if ($scope.filterBattlesForm.fields.to.value && $scope.filterBattlesForm.fields.to.value.length > 0) {
        data.end__lte = $scope.filterBattlesForm.fields.to.value;
      }
      console.info('data', $scope.nicknameFilter, data);
      return $scope.battleList = battleApi.getList(data).then(function(response) {
        $scope.filterBattlesForm.valid = true;
        $scope.filterBattlesForm.submitting = false;
        return $scope.battles = response['objects'];
      }, function(response) {
        $scope.filterBattlesForm.valid = false;
        $scope.filterBattlesForm.submitting = false;
        console.info('response.error', response);
        return $scope.filterBattlesForm.errors = response.data.error;
      });
    };
    $scope.newBattleForm = new AngularForm('.new.battle.modal');
    $scope.newBattleForm.addField('attacker', 'Attacker');
    $scope.newBattleForm.addField('defender', 'Defender');
    $scope.newBattleForm.addField('winner', 'Winner');
    $scope.newBattleForm.addField('start', 'Start', placeholder = exampleDateTime);
    $scope.newBattleForm.addField('end', 'End', placeholder = exampleDateTime, defaultValue = exampleDateTime);
    $scope.battlePlayerFields = [$scope.newBattleForm.fields.attacker, $scope.newBattleForm.fields.defender];
    $scope.battleDatetimeFields = [$scope.newBattleForm.fields.start, $scope.newBattleForm.fields.end];
    $scope.saveBattle = function($event) {
      $event.preventDefault();
      return $scope.newBattleForm.submit(battleApi, $scope.battles);
    };
    return $scope.login();
  };

  BattleApp = angular.module('BattleApp', ['restangular']);

  window.BattleApp = BattleApp;

  BattleApp.config(function(RestangularProvider) {
    return RestangularProvider.setBaseUrl('/api/v1/');
  });

  BattleApp.config(function($interpolateProvider) {
    $interpolateProvider.startSymbol('<<');
    return $interpolateProvider.endSymbol('>>');
  });

  BattleApp.controller('BattleController', BattleController);

}).call(this);
